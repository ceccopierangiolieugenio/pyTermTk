name: _Scratchpad

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

permissions:
  contents: write
  pull-requests: write
  actions: read
  pages: write
  id-token: write

env:
  APPS_ARRAY: '[
        { "name": "pyTermTk"      , "path": "libs/pyTermTk"      , "pypi" : true , "itch" : false },
        { "name": "dumbPaintTool" , "path": "apps/dumbPaintTool" , "pypi" : true , "itch" : true  },
        { "name": "ttkDesigner"   , "path": "apps/ttkDesigner"   , "pypi" : true , "itch" : false },
        { "name": "ttkode"        , "path": "apps/ttkode"        , "pypi" : true , "itch" : false },
        { "name": "tlogg"         , "path": "apps/tlogg"         , "pypi" : true , "itch" : false }
      ]'
  RP_PR: '{
      "releases_created": "false",
      "paths_released": "[]",
      "prs_created": "true",
      "pr": "{\"headBranchName\":\"release-please--branches--main\",\"baseBranchName\":\"main\",\"number\":397,\"title\":\"chore: release main\",\"body\":\":robot: I have created a release *beep* *boop*\\n---\\n\\n\\n<details><summary>pyTermTk: 0.43.0-a.0</summary>\\n\\n## [0.43.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/pyTermTk-v0.42.1-a.0...pyTermTk-v0.43.0-a.0) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **kodeTab:** reworked iterWidget in iterItems\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Fixes\\n\\n* **spinbox:** better check for float, empty strings and negative numbers ([4909bf6](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/4909bf6756000f9450249b28f8c8379a2160415c))\\n\\n\\n### Chores\\n\\n* **kodeTab:** reworked iterWidget in iterItems ([47f73fc](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/47f73fc03a5a049ac3e6073dcadc09018b509328))\\n* **ttk:** workaround timer disconnect in case of error ([d70b2c1](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/d70b2c1c3cf25f7ffb479bc2850b3c9a3ca0fe0c))\\n\\n\\n### Refactors\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n* **TTkColor:** improved typings ([711d611](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/711d611a73be0d0a6fce37e4624b5ae30847dd9c))\\n</details>\\n\\n<details><summary>ttkode: 0.4.0-a.2</summary>\\n\\n## [0.4.0-a.2](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/ttkode-v0.3.2-a.2...ttkode-v0.4.0-a.2) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Refactors\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n</details>\\n\\n<details><summary>tlogg: 0.7.0-a.0</summary>\\n\\n## [0.7.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/tlogg-v0.6.0-a.0...tlogg-v0.7.0-a.0) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Refactors\\n\\n* move the main routine outside the a folder ([#400](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/400)) ([b1bb71f](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/b1bb71fd1ecd9c41a4cb016de15f1d695ea58ba5))\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n</details>\\n\\n---\\nThis PR was generated with [Release Please](https://github.com/googleapis/release-please). See [documentation](https://github.com/googleapis/release-please#release-please).\",\"files\":[],\"labels\":[\"autorelease: pending\"]}",
      "prs": "[{\"headBranchName\":\"release-please--branches--main\",\"baseBranchName\":\"main\",\"number\":397,\"title\":\"chore: release main\",\"body\":\":robot: I have created a release *beep* *boop*\\n---\\n\\n\\n<details><summary>pyTermTk: 0.43.0-a.0</summary>\\n\\n## [0.43.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/pyTermTk-v0.42.1-a.0...pyTermTk-v0.43.0-a.0) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **kodeTab:** reworked iterWidget in iterItems\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Fixes\\n\\n* **spinbox:** better check for float, empty strings and negative numbers ([4909bf6](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/4909bf6756000f9450249b28f8c8379a2160415c))\\n\\n\\n### Chores\\n\\n* **kodeTab:** reworked iterWidget in iterItems ([47f73fc](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/47f73fc03a5a049ac3e6073dcadc09018b509328))\\n* **ttk:** workaround timer disconnect in case of error ([d70b2c1](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/d70b2c1c3cf25f7ffb479bc2850b3c9a3ca0fe0c))\\n\\n\\n### Refactors\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n* **TTkColor:** improved typings ([711d611](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/711d611a73be0d0a6fce37e4624b5ae30847dd9c))\\n</details>\\n\\n<details><summary>ttkode: 0.4.0-a.2</summary>\\n\\n## [0.4.0-a.2](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/ttkode-v0.3.2-a.2...ttkode-v0.4.0-a.2) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Refactors\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n</details>\\n\\n<details><summary>tlogg: 0.7.0-a.0</summary>\\n\\n## [0.7.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/tlogg-v0.6.0-a.0...tlogg-v0.7.0-a.0) (2025-05-28)\\n\\n\\n### ⚠ BREAKING CHANGES\\n\\n* **TabWidget:** tab request close  event need to be handled inside the app\\n\\n### Refactors\\n\\n* move the main routine outside the a folder ([#400](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/400)) ([b1bb71f](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/b1bb71fd1ecd9c41a4cb016de15f1d695ea58ba5))\\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\\n</details>\\n\\n---\\nThis PR was generated with [Release Please](https://github.com/googleapis/release-please). See [documentation](https://github.com/googleapis/release-please#release-please).\",\"files\":[],\"labels\":[\"autorelease: pending\"]}]"
    }'
  RP_REL: '{
      "releases_created": "true",
      "libs/pyTermTk--release_created": "true",
      "libs/pyTermTk--id": "222844982",
      "libs/pyTermTk--name": "pyTermTk: v0.43.0-a.0",
      "libs/pyTermTk--tag_name": "pyTermTk-v0.43.0-a.0",
      "libs/pyTermTk--sha": "edce717e527f2fe93a8a0c7f17e08a6b5fecd7bd",
      "libs/pyTermTk--body": "## [0.43.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/pyTermTk-v0.42.1-a.0...pyTermTk-v0.43.0-a.0) (2025-06-03)\n\n\n### ⚠ BREAKING CHANGES\n\n* **kodeTab:** reworked iterWidget in iterItems\n* **TabWidget:** tab request close  event need to be handled inside the app\n\n### Fixes\n\n* **spinbox:** better check for float, empty strings and negative numbers ([4909bf6](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/4909bf6756000f9450249b28f8c8379a2160415c))\n\n\n### Chores\n\n* autogen code for scrollarea classes ([#406](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/406)) ([fef1b0e](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/fef1b0ea5bd6ddc8f3e8f93a23ea156071e77493))\n* **Input:** add support for ctrl and other key comination ([#404](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/404)) ([5c2bb92](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/5c2bb9202cd819aa573e9f0d9ea966a4d0e5c485))\n* **kodeTab:** reworked iterWidget in iterItems ([47f73fc](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/47f73fc03a5a049ac3e6073dcadc09018b509328))\n* **spinbox:** fix return type ([ddc53a0](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/ddc53a07653a6f3aa958509d7d400cc6c6264d91))\n* **spinbox:** handle left/right wheel  event ([ce961a6](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/ce961a657573ee520b73fca7d4ae721a8837a1d0))\n* **ttk:** workaround timer disconnect in case of error ([d70b2c1](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/d70b2c1c3cf25f7ffb479bc2850b3c9a3ca0fe0c))\n\n\n### Refactors\n\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))\n* **TTkColor:** improved typings ([711d611](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/711d611a73be0d0a6fce37e4624b5ae30847dd9c))",
      "libs/pyTermTk--html_url": "https://github.com/ceccopierangiolieugenio/pyTermTk/releases/tag/pyTermTk-v0.43.0-a.0",
      "libs/pyTermTk--draft": "false",
      "libs/pyTermTk--upload_url": "https://uploads.github.com/repos/ceccopierangiolieugenio/pyTermTk/releases/222844982/assets{?name,label}",
      "libs/pyTermTk--path": "libs/pyTermTk",
      "libs/pyTermTk--version": "0.43.0-a.0",
      "libs/pyTermTk--major": "0",
      "libs/pyTermTk--minor": "43",
      "libs/pyTermTk--patch": "0",
      "libs/pyTermTk--prNumber": "397",
      "apps/ttkode--release_created": "true",
      "apps/ttkode--id": "222844984",
      "apps/ttkode--name": "ttkode: v0.4.0-a.2",
      "apps/ttkode--tag_name": "ttkode-v0.4.0-a.2",
      "apps/ttkode--sha": "edce717e527f2fe93a8a0c7f17e08a6b5fecd7bd",
      "apps/ttkode--body": "## [0.4.0-a.2](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/ttkode-v0.3.2-a.2...ttkode-v0.4.0-a.2) (2025-06-03)\n\n\n### ⚠ BREAKING CHANGES\n\n* **TabWidget:** tab request close  event need to be handled inside the app\n\n### Features\n\n* add save feature ([#407](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/407)) ([26ff9b2](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/26ff9b2f0a81bddadeb6849d5d560ae67406f973))\n\n\n### Refactors\n\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))",
      "apps/ttkode--html_url": "https://github.com/ceccopierangiolieugenio/pyTermTk/releases/tag/ttkode-v0.4.0-a.2",
      "apps/ttkode--draft": "false",
      "apps/ttkode--upload_url": "https://uploads.github.com/repos/ceccopierangiolieugenio/pyTermTk/releases/222844984/assets{?name,label}",
      "apps/ttkode--path": "apps/ttkode",
      "apps/ttkode--version": "0.4.0-a.2",
      "apps/ttkode--major": "0",
      "apps/ttkode--minor": "4",
      "apps/ttkode--patch": "0",
      "apps/ttkode--prNumber": "397",
      "apps/tlogg--release_created": "true",
      "apps/tlogg--id": "222844986",
      "apps/tlogg--name": "tlogg: v0.7.0-a.0",
      "apps/tlogg--tag_name": "tlogg-v0.7.0-a.0",
      "apps/tlogg--sha": "edce717e527f2fe93a8a0c7f17e08a6b5fecd7bd",
      "apps/tlogg--body": "## [0.7.0-a.0](https://github.com/ceccopierangiolieugenio/pyTermTk/compare/tlogg-v0.6.0-a.0...tlogg-v0.7.0-a.0) (2025-06-03)\n\n\n### ⚠ BREAKING CHANGES\n\n* **TabWidget:** tab request close  event need to be handled inside the app\n\n### Refactors\n\n* move the main routine outside the a folder ([#400](https://github.com/ceccopierangiolieugenio/pyTermTk/issues/400)) ([b1bb71f](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/b1bb71fd1ecd9c41a4cb016de15f1d695ea58ba5))\n* **TabWidget:** tab request close  event need to be handled inside the app ([9420adf](https://github.com/ceccopierangiolieugenio/pyTermTk/commit/9420adf68e2184482cd71266f280c560ea911f45))",
      "apps/tlogg--html_url": "https://github.com/ceccopierangiolieugenio/pyTermTk/releases/tag/tlogg-v0.7.0-a.0",
      "apps/tlogg--draft": "false",
      "apps/tlogg--upload_url": "https://uploads.github.com/repos/ceccopierangiolieugenio/pyTermTk/releases/222844986/assets{?name,label}",
      "apps/tlogg--path": "apps/tlogg",
      "apps/tlogg--version": "0.7.0-a.0",
      "apps/tlogg--major": "0",
      "apps/tlogg--minor": "7",
      "apps/tlogg--patch": "0",
      "apps/tlogg--prNumber": "397",
      "paths_released": "[\"libs/pyTermTk\",\"apps/ttkode\",\"apps/tlogg\"]",
      "prs_created": "false"
    }'

jobs:
  test:
    # runs-on: ubuntu-latest
    runs-on: self-hosted

    steps:
      - run: echo Scratchpad
        env:
          GH: ${{ toJson(github) }}
          GHE: ${{ toJson(github.event) }}
          GHEH: ${{ toJson(github.event.head_commit) }}
          GHEHM: ${{ toJson(github.event.head_commit.modified) }}
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Use the array
        shell: bash
        run: |
          _get_name(){
            _ITEM=$1
            jq -r ".packages[\"${_ITEM}\"][\"package-name\"]" .release-please-config.json
          }
          _get_version(){
            _ITEM=$1
            jq -r ".[\"${_ITEM}\"]" .release-please-manifest.json
          }

          # Parse the JSON string into a Bash array
          my_bash_array=($(jq -r '.[].name' <<< ${APPS_ARRAY}))
          echo ${my_bash_array}
          # Loop through the array
          for item in "${my_bash_array[@]}"; do
            # Update version in the project
            _VERSION=$(_get_version ${item})
            _NAME=$(_get_name ${item})
            echo "(${item}) Version ${_VERSION}: ${_NAME}"
          done

          # Loop through the array
          for item in $(jq -r '.[].name' <<< ${APPS_ARRAY}) ; do
            # Update version in the project
            _VERSION=$(_get_version ${item})
            _NAME=$(_get_name ${item})
            echo "(${item}) Version ${_VERSION}: ${_NAME}"
          done

          # Loop through the array
          for item in $(jq -r '.[].path' <<< ${APPS_ARRAY}) ; do
            # Update version in the project
            _VERSION=$(_get_version ${item})
            _NAME=$(_get_name ${item})
            echo "(${item}) Version ${_VERSION}: ${_NAME}"
          done

  test-si-tools:
    if: False
    runs-on: self-hosted
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
      - name: Install dependencies
        shell: bash
        run:
          pip install -e tools/ci
      - name: Test Things
        shell: bash
        run: |
          echo '::group::🍧 Print the Versions'
           release-helper \
              --config .release-please-config.json \
              --manifest .release-please-manifest.json \
              info
          echo '::endgroup::'

          echo '::group::🍓 Update the Versions'

            _VERSION_TTK=$(_get_name libs/pyTermTk)

            sed -i \
              "s|__version__:str.*|__version__:str = '${_VERSION_TTK}'|" \
              libs/pyTermTk/TermTk/__init__.py

            for item in $(jq -r '.[].path' <<< ${APPS_ARRAY}) ; do; do
              # Update version in the project
              _VERSION=$(_get_version ${item})
              _NAME=$(_get_name ${item})
              if grep -q "${_NAME}: ${_VERSION}" <<< ' ${{ steps.release-please.outputs.pr }}' ; then
                sed -i \
                  "s|__version__:str.*|__version__:str = '${_VERSION}'|" \
                  ${item}/*/__init__.py
                sed  "s|'pyTermTk *>=[^']*'|'pyTermTk>=${_VERSION_TTK}'|" -i ${item}/pyproject.toml
                echo ✅ Bumped ${_NAME} to ${_VERSION}
              else
                echo 🆗 No new release found for ${_NAME}
              fi
            done

            cp libs/pyTermTk/CHANGELOG.md CHANGELOG.md
          echo '::endgroup::'

  generate-matrix:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      matrix-pypi: ${{ steps.set-matrix.outputs.matrix_pypi }}
      matrix-itch: ${{ steps.set-matrix.outputs.matrix_itch }}
      matrix-void: ${{ steps.set-matrix.outputs.void }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        shell: bash
        run:
          pip install -e tools/ci
      - name: Convert global APPS_ARRAY to matrix
        id: set-matrix
        run: |
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
            release-helper \
              --config .release-please-config.json \
              --manifest .release-please-manifest.json \
              matrix all <<< ${RP_PR} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "matrix_itch<<EOF" >> $GITHUB_OUTPUT
            release-helper \
              --config .release-please-config.json \
              --manifest .release-please-manifest.json \
              matrix itch <<< ${RP_PR} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "matrix_pypi<<EOF" >> $GITHUB_OUTPUT
            release-helper \
              --config .release-please-config.json \
              --manifest .release-please-manifest.json \
              matrix pypi <<< ${RP_PR} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # echo matrix=$(jq '[.[]]' <<< ${APPS_ARRAY}) >> $GITHUB_OUTPUT
          # echo matrix_itch=$(jq '[.[] | select(.itch == true)]' <<< ${APPS_ARRAY}) >> $GITHUB_OUTPUT
          # echo matrix_pypi=$(jq '[.[] | select(.pypi == true)]' <<< ${APPS_ARRAY}) >> $GITHUB_OUTPUT
          echo matrix_void='[]' >> $GITHUB_OUTPUT
      - name: Print Output
        env:
          OUT:    ${{ toJSON(steps.set-matrix.outputs) }}
          OUT1:   ${{ toJSON(steps.set-matrix.outputs.matrix) }}
          OUT2.1: ${{ toJSON(steps.set-matrix.outputs.matrix)['matrix'] }}
          OUT2.2: ${{ toJSON(steps.set-matrix.outputs.matrix['matrix']) }}
          OUT2.3: ${{ fromJson(toJSON(steps.set-matrix.outputs.matrix))['matrix'] }}
          OUT2.4: ${{ fromJson(toJSON(steps.set-matrix.outputs.matrix)).matrix }}
          OUT2.5: ${{ fromJson(toJSON(steps.set-matrix.outputs.matrix)) }}
          # OUT2.6: ${{ fromJson(steps.set-matrix.outputs.matrix) }}
          OUT2.7: ${{ steps.set-matrix.outputs.matrix }}
        run: |
          echo: $OUT

  build:
    if:  ${{ fromJson(needs.generate-matrix.outputs.matrix['has_matrix']) }}
    name: Build ${{ matrix.name }}
    needs: generate-matrix
    runs-on: self-hosted
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix['matrix']) }}
    steps:
      - name: Build ${{ matrix.name }}
        run: |
          echo "Building ${{ matrix.name }} at path: ${{ matrix.path }}"

  publish-pypi:
    if:  ${{ fromJson(needs.generate-matrix.outputs.matrix-pypi['has_matrix']) }}
    name: Publish pypi ${{ matrix.name }}
    needs: generate-matrix
    runs-on: self-hosted
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-pypi['matrix']) }}
    steps:
      - name: Build ${{ matrix.name }}
        run: |
          echo "Building ${{ matrix.name }} at path: ${{ matrix.path }}"

  publish-itch:
    if:  ${{ fromJson(needs.generate-matrix.outputs.matrix-itch['has_matrix']) }}
    name: Publish Itch ${{ matrix.name }}
    needs: generate-matrix
    runs-on: self-hosted
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-itch['matrix']) }}
    steps:
      - name: Build ${{ matrix.name }}
        run: |
          echo "Building ${{ matrix.name }} at path: ${{ matrix.path }}"

  publish-void:
    if: ${{ fromJson(needs.generate-matrix.outputs.matrix-void) != '[]' }}
    name: Publish Void ${{ matrix.name }}
    needs: generate-matrix
    runs-on: self-hosted
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-void) }}
    steps:
      - name: Build ${{ matrix.name }}
        run: |
          echo "Building ${{ matrix.name }} at path: ${{ matrix.path }}"

